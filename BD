-- ================================================
-- BASE DE DATOS: ciudad_segura - Versión Definitiva
-- Fecha: Diciembre 2025
-- ================================================

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Enums
CREATE TYPE rol_usuario AS ENUM ('ciudadano', 'administrador', 'autoridad');

CREATE TYPE categoria_denuncia AS ENUM ('obstruccion', 'invasion', 'zonas', 'accesos', 'conducta');

CREATE TYPE estado_denuncia AS ENUM ('pendiente', 'en_revision', 'resuelto', 'urgente');

CREATE TYPE tipo_notificacion AS ENUM (
    'actualizacion', 'resuelta', 'nueva_denuncia', 'denuncia_creada', 
    'denuncia_actualizada', 'denuncia_cercana', 'alerta_sistema'
);

-- usuarios (ciudadanos, administradores y autoridades)
CREATE TABLE usuarios (
    id                  SERIAL PRIMARY KEY,
    dni                 VARCHAR(20) UNIQUE NOT NULL,
    nombres             VARCHAR(100) NOT NULL,
    apellidos           VARCHAR(100) NOT NULL,
    correo              VARCHAR(255) UNIQUE NOT NULL,
    telefono            VARCHAR(20),
    contraseña_hash     VARCHAR(255) NOT NULL,
    rol                 rol_usuario NOT NULL DEFAULT 'ciudadano',
    estado              VARCHAR(50) DEFAULT 'activo',
    fecha_creacion      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- organizaciones
CREATE TABLE organizaciones (
    id                  SERIAL PRIMARY KEY,
    nombre              VARCHAR(255) NOT NULL,
    correo_contacto     VARCHAR(255),
    numero_contacto     VARCHAR(20),
    ubicacion           JSONB,  -- { "lat": -13.5167, "lng": -71.9781 }
    fecha_creacion      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- detalle de autoridades (vincula usuario autoridad con su organización y cargo)
CREATE TABLE autoridades_detalle (
    usuario_id          INTEGER PRIMARY KEY REFERENCES usuarios(id) ON DELETE CASCADE,
    organizacion_id     INTEGER NOT NULL REFERENCES organizaciones(id) ON DELETE RESTRICT,
    cargo               VARCHAR(100) NOT NULL,
    fecha_asignacion    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- denuncias (asignadas a una ORGANIZACIÓN)
CREATE TABLE denuncias (
    id                          SERIAL PRIMARY KEY,
    codigo_seguimiento          VARCHAR(50) UNIQUE NOT NULL,     -- ej: D-2025-001
    usuario_id                  INTEGER REFERENCES usuarios(id) ON DELETE SET NULL,  -- Ciudadano que reporta (NULL si anónima)
    organizacion_asignada_id    INTEGER REFERENCES organizaciones(id) ON DELETE SET NULL,  -- <<-- ASIGNACIÓN A ORGANIZACIÓN
    categoria                   categoria_denuncia NOT NULL,
    titulo                      VARCHAR(255),
    descripcion                 TEXT NOT NULL,
    placa                       VARCHAR(10),
    ubicacion                   JSONB NOT NULL,                  -- { lat, lng, direccion }
    evidencias                  JSONB,                           -- array de URLs
    referencia                  TEXT,
    estado                      estado_denuncia DEFAULT 'pendiente',
    fecha_creacion              TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- eventos_denuncia (timeline: asignaciones, cambios de estado, comentarios, etc.)
CREATE TABLE eventos_denuncia (
    id                  SERIAL PRIMARY KEY,
    denuncia_id         INTEGER REFERENCES denuncias(id) ON DELETE CASCADE NOT NULL,
    titulo              VARCHAR(100) NOT NULL,  -- ej: "Asignada a organización", "Tomada por autoridad", "Estado cambiado"
    descripcion         TEXT,
    fecha               TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- notificaciones
CREATE TABLE notificaciones (
    id                  SERIAL PRIMARY KEY,
    usuario_id          INTEGER REFERENCES usuarios(id) ON DELETE CASCADE NOT NULL,
    tipo                tipo_notificacion NOT NULL,
    mensaje             TEXT NOT NULL,
    leida               BOOLEAN DEFAULT FALSE,
    denuncia_id         INTEGER REFERENCES denuncias(id) ON DELETE SET NULL,
    fecha_creacion      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Índices útiles
CREATE INDEX idx_usuarios_correo                ON usuarios(correo);
CREATE INDEX idx_usuarios_rol                   ON usuarios(rol);
CREATE INDEX idx_denuncias_usuario_id           ON denuncias(usuario_id);
CREATE INDEX idx_denuncias_organizacion_asignada ON denuncias(organizacion_asignada_id);  -- <<-- Muy importante para filtrar por organización
CREATE INDEX idx_denuncias_estado               ON denuncias(estado);
CREATE INDEX idx_denuncias_categoria            ON denuncias(categoria);
CREATE INDEX idx_notificaciones_usuario         ON notificaciones(usuario_id);

-- Vista de estadísticas
CREATE VIEW vista_estadisticas AS
SELECT 
    COUNT(*) AS total_denuncias,
    COUNT(CASE WHEN estado = 'resuelto' THEN 1 END) AS denuncias_resueltas,
    ROUND(AVG(EXTRACT(EPOCH FROM (fecha_actualizacion - fecha_creacion)) / 3600), 2) AS tiempo_promedio_resolucion_horas,
    categoria,
    COUNT(*) AS cantidad_por_categoria
FROM denuncias
GROUP BY categoria;